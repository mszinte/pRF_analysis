"""-----------------------------------------------------------------------------------------merge_fig_prf.py-----------------------------------------------------------------------------------------Goal of the script:Concat all pycortex maps and prf figures of one subject in one pdf-----------------------------------------------------------------------------------------Input(s):sys.argv[1]: main project directorysys.argv[2]: project name (correspond to directory)sys.argv[3]: number of subjectssys.argv[4]: group-----------------------------------------------------------------------------------------Output(s):one pdf file with pycortex maps and one pdf file with prf figures-----------------------------------------------------------------------------------------To run:0. To Run on meso (not on node)1. cd to function>>  cd ~/projects/pRF_analysis/analysis_code/postproc/prf/postfit2. run python command>> python merge_fig_prf.py [main directory] [project name] [subject num] [group]-----------------------------------------------------------------------------------------Exemple:cd ~/projects/pRF_analysis/analysis_code/postproc/prf/postfitpython merge_fig_prf.py /scratch/mszinte/data RetinoMaps sub-01 327python merge_fig_prf.py /scratch/mszinte/data RetinoMaps sub-170k 327python merge_fig_prf.py /scratch/mszinte/data RetinoMaps group 327-----------------------------------------------------------------------------------------Written by Uriel Lascombes (uriel.lascombes@laposte.net)Edited by Martin Szinte (martin.szinte@gmail.com)-----------------------------------------------------------------------------------------"""# General importsimport osimport sysimport yamlimport globfrom pypdf import PdfWriter# Personal importssys.path.append("{}/../../../utils".format(os.getcwd()))from settings_utils import load_settings# Debugimport ipdbdeb = ipdb.set_trace# Inputsmain_dir = sys.argv[1]project_dir = sys.argv[2]subject = sys.argv[3]group = sys.argv[4]# load settings# Load settingsbase_dir = os.path.abspath(os.path.join(os.getcwd(), "../../../../"))settings_path = os.path.join(base_dir, project_dir, "settings.yml")prf_settings_path = os.path.join(base_dir, project_dir, "prf-analysis.yml")settings = load_settings([settings_path, prf_settings_path])analysis_info = settings[0]if subject == 'sub-170k':     formats = ['170k']    extensions = ['dtseries.nii']else:     formats = analysis_info['formats']    extensions = analysis_info['extensions']preproc_prep = analysis_info['preproc_prep']filtering = analysis_info['filtering']normalization = analysis_info['normalization']avg_methods = analysis_info['avg_methods']prf_task_names = analysis_info['prf_task_names']rois_methods = analysis_info['rois_methods']# define pp dirpp_dir = '{}/{}/derivatives/pp_data'.format(    main_dir, project_dir)for avg_method in avg_methods:            for format_, extension in zip(formats, extensions):           # Define output directory and file        prf_merge_dir = '{}/{}/{}/prf/merged'.format(             pp_dir, subject, format_)        os.makedirs(prf_merge_dir, exist_ok = True)                # define list of rois for each format        rois_methods_format = rois_methods[format_]        for rois_method_format in rois_methods_format:            for prf_task_name in prf_task_names:                # define fn                fn_spec = "task-{}_{}_{}_{}_{}_{}".format(                    prf_task_name, preproc_prep, filtering,                     normalization, avg_method, rois_method_format)                    # Find flatmaps                prf_flatmaps_fns = []                prf_flatmaps_fns.extend(glob.glob(                    "{}/{}/{}/corr/pycortex/flatmaps_corr/*{}*.pdf".format(                        pp_dir, subject, format_, prf_task_name)))                prf_flatmaps_fns.extend(glob.glob(                    "{}/{}/{}/prf/pycortex/flatmaps_gauss/*{}*.pdf".format(                        pp_dir, subject, format_, fn_spec)))                prf_flatmaps_fns.extend(glob.glob(                    "{}/{}/{}/prf/pycortex/flatmaps_css/*{}*.pdf".format(                        pp_dir, subject, format_, fn_spec)))                    # Sort the list alphabetically                prf_flatmaps_fns = sorted(prf_flatmaps_fns)                    # Merge pdf and export final pdf                 prf_flatmaps_merged_fn = '{}/{}_{}_prf_flatmaps.pdf'.format(                    prf_merge_dir, subject, fn_spec)                    if 'group' not in subject:                    prf_flatmaps_merger = PdfWriter()                    for n_page, prf_flatmaps_fn in enumerate(prf_flatmaps_fns):                         prf_flatmaps_merger.append(prf_flatmaps_fn)                                            # Export the pdf                     print("Saving {}".format(prf_flatmaps_merged_fn))                    prf_flatmaps_merger.write(prf_flatmaps_merged_fn)                    prf_flatmaps_merger.close()                        # Find figures                prf_figures_fns = []                prf_figures_fns.extend(glob.glob(                    "{}/{}/{}/prf/figures/*{}*.pdf".format(                        pp_dir, subject, format_, fn_spec)))                    # Sort the list alphabetically                prf_figures_fns = sorted(prf_figures_fns)                    # Merge pdf and export final pdf                 prf_figures_merged_fn = '{}/{}_{}_prf-css_figures.pdf'.format(                    prf_merge_dir, subject, fn_spec)                                prf_figures_merger = PdfWriter()                for n_page, prf_figures_fn in enumerate(prf_figures_fns):                     print(prf_figures_fn)                    prf_figures_merger.append(prf_figures_fn)                                    # Export the pdf                 print("Saving {}".format(prf_figures_merged_fn))                prf_figures_merger.write(prf_figures_merged_fn)                prf_figures_merger.close()        # Define permission cmdprint('Changing files permissions in {}/{}'.format(main_dir, project_dir))os.system("chmod -Rf 771 {}/{}".format(main_dir, project_dir))os.system("chgrp -Rf {} {}/{}".format(group, main_dir, project_dir))